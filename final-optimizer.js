#!/usr/bin/env node

/**
 * ü¶ä Otimizador Final - AI Exporter Firefox Extension
 * Aplica otimiza√ß√µes finais e corre√ß√µes para vers√£o de produ√ß√£o
 */

const fs = require('fs');
const path = require('path');

const GREEN = '\x1b[32m';
const RED = '\x1b[31m';
const YELLOW = '\x1b[33m';
const BLUE = '\x1b[34m';
const RESET = '\x1b[0m';

class FinalOptimizer {
  constructor() {
    this.basePath = process.cwd();
    this.optimizations = [];
    this.errors = [];
    this.stats = {
      filesOptimized: 0,
      sizeReduced: 0,
      errorsFixed: 0
    };
  }

  async optimize() {
    console.log(`${BLUE}ü¶ä Otimizador Final - AI Exporter v3.5.4${RESET}\n`);

    try {
      await this.validateStructure();
      await this.optimizeManifest();
      await this.optimizeJavaScript();
      await this.optimizeCSS();
      await this.optimizeHTML();
      await this.optimizeLocales();
      await this.cleanupUnnecessaryFiles();
      await this.validateFinalState();
      
      this.displayResults();
      return this.errors.length === 0;
    } catch (error) {
      console.error(`${RED}‚ùå Erro cr√≠tico durante otimiza√ß√£o:${RESET}`, error);
      return false;
    }
  }

  async validateStructure() {
    console.log(`${YELLOW}üìã Validando estrutura do projeto...${RESET}`);
    
    const requiredFiles = [
      'manifest.json',
      'browser-polyfill.js',
      'dist/background/firefox-background.js',
      'dist/popup/index.html',
      'dist/popup/popup.js',
      'dist/options/enhanced-options.html',
      'dist/options/enhanced-options.js',
      'dist/contentScripts/ai-exporter-content.js',
      'dist/contentScripts/style.css',
      'dist/contentScripts/index.global.js'
    ];

    let missingFiles = [];
    for (const file of requiredFiles) {
      if (!fs.existsSync(path.join(this.basePath, file))) {
        missingFiles.push(file);
      }
    }

    if (missingFiles.length > 0) {
      this.errors.push(`Arquivos obrigat√≥rios faltando: ${missingFiles.join(', ')}`);
    } else {
      this.optimizations.push('‚úÖ Todos os arquivos obrigat√≥rios presentes');
    }
  }

  async optimizeManifest() {
    console.log(`${YELLOW}üîß Otimizando manifest.json...${RESET}`);
    
    const manifestPath = path.join(this.basePath, 'manifest.json');
    const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
    
    let changes = 0;
    
    // Verificar se todos os sites est√£o listados corretamente
    const expectedSites = [
      "https://chatgpt.com/*",
      "https://claude.ai/*", 
      "https://gemini.google.com/*",
      "https://chat.deepseek.com/*",
      "https://grok.x.ai/*",
      "https://www.perplexity.ai/*",
      "https://aistudio.google.com/*",
      "https://poe.com/*",
      "https://you.com/*",
      "https://copilot.microsoft.com/*",
      "https://character.ai/*"
    ];
    
    // Atualizar host_permissions se necess√°rio
    if (JSON.stringify(manifest.host_permissions) !== JSON.stringify(expectedSites)) {
      manifest.host_permissions = expectedSites;
      changes++;
    }
    
    // Garantir que content_scripts esteja sincronizado
    if (manifest.content_scripts && manifest.content_scripts[0]) {
      if (JSON.stringify(manifest.content_scripts[0].matches) !== JSON.stringify(expectedSites)) {
        manifest.content_scripts[0].matches = expectedSites;
        changes++;
      }
    }
    
    // Otimizar CSP se necess√°rio
    if (!manifest.content_security_policy || 
        !manifest.content_security_policy.extension_pages) {
      manifest.content_security_policy = {
        extension_pages: "script-src 'self' 'unsafe-inline'; object-src 'self'"
      };
      changes++;
    }
    
    if (changes > 0) {
      fs.writeFileSync(manifestPath, JSON.stringify(manifest, null, 2));
      this.optimizations.push(`üîß Manifest.json otimizado (${changes} mudan√ßas)`);
      this.stats.filesOptimized++;
    }
  }

  async optimizeJavaScript() {
    console.log(`${YELLOW}‚ö° Otimizando arquivos JavaScript...${RESET}`);
    
    const jsFiles = [
      'dist/background/firefox-background.js',
      'dist/popup/popup.js',
      'dist/options/enhanced-options.js',
      'dist/contentScripts/ai-exporter-content.js',
      'dist/contentScripts/index.global.js'
    ];
    
    for (const file of jsFiles) {
      const filePath = path.join(this.basePath, file);
      
      if (fs.existsSync(filePath)) {
        let content = fs.readFileSync(filePath, 'utf8');
        const originalSize = content.length;
        
        // Remover console.logs desnecess√°rios (manter apenas importantes)
        content = content.replace(/console\.log\([^)]*'[^']*debug[^']*'[^)]*\);?\n?/gi, '');
        content = content.replace(/console\.debug\([^)]*\);?\n?/gi, '');
        
        // Remover coment√°rios de desenvolvimento
        content = content.replace(/\/\/ TODO:.*$/gm, '');
        content = content.replace(/\/\/ FIXME:.*$/gm, '');
        content = content.replace(/\/\* DEBUG[\s\S]*?\*\//g, '');
        
        // Otimizar espa√ßos em branco excessivos
        content = content.replace(/\n{3,}/g, '\n\n');
        content = content.replace(/[ \t]+$/gm, '');
        
        const newSize = content.length;
        const reduction = originalSize - newSize;
        
        if (reduction > 0) {
          fs.writeFileSync(filePath, content);
          this.optimizations.push(`‚ö° ${file} otimizado (-${reduction} bytes)`);
          this.stats.sizeReduced += reduction;
          this.stats.filesOptimized++;
        }
      }
    }
  }

  async optimizeCSS() {
    console.log(`${YELLOW}üé® Otimizando arquivos CSS...${RESET}`);
    
    const cssFiles = [
      'dist/contentScripts/style.css',
      'dist/sidebar/firefox-sidebar.css'
    ];
    
    for (const file of cssFiles) {
      const filePath = path.join(this.basePath, file);
      
      if (fs.existsSync(filePath)) {
        let content = fs.readFileSync(filePath, 'utf8');
        const originalSize = content.length;
        
        // Remover coment√°rios desnecess√°rios
        content = content.replace(/\/\* TODO[\s\S]*?\*\//g, '');
        content = content.replace(/\/\* DEBUG[\s\S]*?\*\//g, '');
        
        // Otimizar espa√ßos
        content = content.replace(/\n{3,}/g, '\n\n');
        content = content.replace(/[ \t]+$/gm, '');
        
        // Combinar regras duplicadas simples
        content = content.replace(/(\.[a-zA-Z-]+)\s*\{\s*([^}]+)\s*\}\s*\1\s*\{\s*([^}]+)\s*\}/g, 
                                  '$1 { $2; $3 }');
        
        const newSize = content.length;
        const reduction = originalSize - newSize;
        
        if (reduction > 0) {
          fs.writeFileSync(filePath, content);
          this.optimizations.push(`üé® ${file} otimizado (-${reduction} bytes)`);
          this.stats.sizeReduced += reduction;
          this.stats.filesOptimized++;
        }
      }
    }
  }

  async optimizeHTML() {
    console.log(`${YELLOW}üìÑ Otimizando arquivos HTML...${RESET}`);
    
    const htmlFiles = [
      'dist/popup/index.html',
      'dist/options/enhanced-options.html',
      'dist/options/index.html',
      'dist/sidebar/firefox-sidebar.html',
      'dist/help/index.html',
      'dist/editor/index.html'
    ];
    
    for (const file of htmlFiles) {
      const filePath = path.join(this.basePath, file);
      
      if (fs.existsSync(filePath)) {
        let content = fs.readFileSync(filePath, 'utf8');
        const originalSize = content.length;
        
        // Remover coment√°rios HTML desnecess√°rios
        content = content.replace(/<!--[\s\S]*?-->/g, '');
        
        // Otimizar espa√ßos em branco
        content = content.replace(/\s+/g, ' ');
        content = content.replace(/>\s+</g, '><');
        content = content.replace(/\n{2,}/g, '\n');
        
        // Garantir encoding correto
        if (!content.includes('charset="UTF-8"')) {
          content = content.replace(/<meta/, '<meta charset="UTF-8">\n  <meta');
        }
        
        const newSize = content.length;
        const reduction = originalSize - newSize;
        
        if (reduction > 10) { // S√≥ otimizar se a redu√ß√£o for significativa
          fs.writeFileSync(filePath, content);
          this.optimizations.push(`üìÑ ${file} otimizado (-${reduction} bytes)`);
          this.stats.sizeReduced += reduction;
          this.stats.filesOptimized++;
        }
      }
    }
  }

  async optimizeLocales() {
    console.log(`${YELLOW}üåê Otimizando arquivos de localiza√ß√£o...${RESET}`);
    
    const localesDir = path.join(this.basePath, '_locales');
    
    if (fs.existsSync(localesDir)) {
      const locales = fs.readdirSync(localesDir);
      
      for (const locale of locales) {
        const messagesFile = path.join(localesDir, locale, 'messages.json');
        
        if (fs.existsSync(messagesFile)) {
          try {
            const messages = JSON.parse(fs.readFileSync(messagesFile, 'utf8'));
            const originalSize = JSON.stringify(messages).length;
            
            // Garantir campos obrigat√≥rios
            const requiredKeys = ['extensionName', 'extensionDescription'];
            let modified = false;
            
            for (const key of requiredKeys) {
              if (!messages[key]) {
                console.warn(`${YELLOW}‚ö†Ô∏è  Campo ${key} faltando em ${locale}${RESET}`);
                this.errors.push(`Campo obrigat√≥rio ${key} faltando em locale ${locale}`);
              }
            }
            
            // Compactar JSON
            const compactJSON = JSON.stringify(messages, null, 2);
            const newSize = compactJSON.length;
            
            if (newSize !== originalSize) {
              fs.writeFileSync(messagesFile, compactJSON);
              modified = true;
            }
            
            if (modified) {
              this.optimizations.push(`üåê Locale ${locale} otimizado`);
              this.stats.filesOptimized++;
            }
          } catch (error) {
            this.errors.push(`Erro no arquivo de locale ${locale}: ${error.message}`);
          }
        }
      }
    }
  }

  async cleanupUnnecessaryFiles() {
    console.log(`${YELLOW}üßπ Limpando arquivos desnecess√°rios...${RESET}`);
    
    const unnecessaryPatterns = [
      '**/*.tmp',
      '**/*.log',
      '**/.DS_Store',
      '**/Thumbs.db',
      '**/*.bak',
      '**/*.orig',
      'node_modules/**',
      '.git/**',
      '**/*.map'
    ];
    
    // Arquivos espec√≠ficos desnecess√°rios
    const specificFiles = [
      'package.json',
      'package-lock.json',
      'webpack.config.js',
      'tsconfig.json',
      '.gitignore',
      'yarn.lock'
    ];
    
    let cleanedFiles = 0;
    
    for (const file of specificFiles) {
      const filePath = path.join(this.basePath, file);
      if (fs.existsSync(filePath)) {
        fs.unlinkSync(filePath);
        cleanedFiles++;
      }
    }
    
    if (cleanedFiles > 0) {
      this.optimizations.push(`üßπ ${cleanedFiles} arquivos desnecess√°rios removidos`);
    }
  }

  async validateFinalState() {
    console.log(`${YELLOW}‚úÖ Validando estado final...${RESET}`);
    
    try {
      // Validar manifest.json
      const manifest = JSON.parse(fs.readFileSync(path.join(this.basePath, 'manifest.json'), 'utf8'));
      
      if (!manifest.version) {
        this.errors.push('Vers√£o n√£o especificada no manifest');
      }
      
      if (!manifest.permissions || manifest.permissions.length === 0) {
        this.errors.push('Nenhuma permiss√£o especificada no manifest');
      }
      
      // Verificar tamanho total
      const totalSize = this.calculateDirectorySize(this.basePath);
      const maxSize = 50 * 1024 * 1024; // 50MB
      
      if (totalSize > maxSize) {
        this.errors.push(`Extens√£o muito grande: ${(totalSize / 1024 / 1024).toFixed(2)}MB (m√°ximo: 50MB)`);
      } else {
        this.optimizations.push(`üìè Tamanho final: ${(totalSize / 1024).toFixed(2)}KB`);
      }
      
    } catch (error) {
      this.errors.push(`Erro na valida√ß√£o final: ${error.message}`);
    }
  }

  calculateDirectorySize(dirPath) {
    let totalSize = 0;
    
    function calculateSize(currentPath) {
      const stats = fs.statSync(currentPath);
      
      if (stats.isFile()) {
        totalSize += stats.size;
      } else if (stats.isDirectory()) {
        const files = fs.readdirSync(currentPath);
        files.forEach(file => {
          calculateSize(path.join(currentPath, file));
        });
      }
    }
    
    calculateSize(dirPath);
    return totalSize;
  }

  displayResults() {
    console.log(`\n${BLUE}üìä RELAT√ìRIO DE OTIMIZA√á√ÉO FINAL${RESET}`);
    console.log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);
    
    console.log(`\n${GREEN}‚úÖ OTIMIZA√á√ïES APLICADAS:${RESET}`);
    this.optimizations.forEach(opt => console.log(`  ${opt}`));
    
    if (this.errors.length > 0) {
      console.log(`\n${RED}‚ùå PROBLEMAS ENCONTRADOS:${RESET}`);
      this.errors.forEach(error => console.log(`  ‚ùå ${error}`));
    }
    
    console.log(`\n${BLUE}üìà ESTAT√çSTICAS:${RESET}`);
    console.log(`  üìÅ Arquivos otimizados: ${this.stats.filesOptimized}`);
    console.log(`  üíæ Tamanho reduzido: ${this.stats.sizeReduced} bytes`);
    console.log(`  üîß Problemas corrigidos: ${this.stats.errorsFixed}`);
    
    if (this.errors.length === 0) {
      console.log(`\n${GREEN}üéâ OTIMIZA√á√ÉO FINAL CONCLU√çDA COM SUCESSO!${RESET}`);
      console.log(`${GREEN}ü¶ä A extens√£o AI Exporter est√° pronta para produ√ß√£o!${RESET}`);
    } else {
      console.log(`\n${RED}‚ö†Ô∏è  OTIMIZA√á√ÉO CONCLU√çDA COM PROBLEMAS${RESET}`);
      console.log(`${YELLOW}Por favor, resolva os problemas listados acima.${RESET}`);
    }
  }
}

// Executar otimiza√ß√£o
if (require.main === module) {
  const optimizer = new FinalOptimizer();
  optimizer.optimize().then(success => {
    process.exit(success ? 0 : 1);
  });
}

module.exports = FinalOptimizer;
